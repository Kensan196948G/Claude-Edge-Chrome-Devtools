# 📄 ClaudeCode 統合運用プロンプト vNext (2.1.50 + MCPフル活用 + 自己修復ループ v4 統合完全版)

## (2.1.50 + MCPフル活用 + 自己修復ループ v4 統合完全版)

（Agent Teams + Memory MCP + Claude-mem + Worktree Isolation + 各種MCP連携 + CI学習型自己修復）

---

# 🧭 0. 基本方針

ClaudeCode 2.1.50 の機能および接続済みMCP群を最大限活用せよ。
本仕様は **開発オーケストレーション制御仕様** であり、例外なく遵守すること。

同時に実現すること：

* 設計の一貫性
* 記憶の継続性
* 並列開発効率の最大化
* 自動レビュー品質の向上
* CI連動型自己修復（学習型）

---

# 0-1. MCP優先順位とフォールバック順

（※変更なし、あなたの記述を維持）

（略：ここは既存内容のまま）

---

# 0-2. 自動ブラウザ操作の安全柵（必須）

（※変更なし、既存内容維持）

---

# ① 開発開始時の自動実行プロトコル

（※既存内容維持）

---

# ② Agent Teams + Worktree衝突回避

（※既存内容維持）

---

# ③ レビュー・テスト統合プロトコル

（※既存内容維持）

---

# ④ Git / CI / 🔁 自己修復ループ v4（学習型）

## 🔁 v4 概要

自己修復は単なる再試行ではない。
**CI失敗パターンを記録し、次回以降の修復精度を向上させる学習型ループ**とする。

---

## 🔁 自己修復フロー（v4）

### Phase 1：ログ取得

1. `github` MCPでCIログ取得
2. エラー種別分類：

   * Lintエラー
   * テスト失敗
   * ビルドエラー
   * 依存関係エラー
   * 型エラー
   * E2E失敗
   * 環境依存エラー

---

### Phase 2：原因分析

* 最小単位で原因特定
* 影響ファイル範囲を限定
* 再現可能性の確認
* 既存Memoryに類似失敗があるか検索

優先検索順：

```
memory
→ claude-mem
→ context7
```

---

### Phase 3：修正戦略決定

修正は必ず以下順で検討せよ：

1. 設定修正（config）
2. テスト修正（期待値修正）
3. 実装修正（ロジック修正）
4. 依存関係修正

最小差分を原則とする。

---

### Phase 4：再実行制御

自己修復ループには必ず：

* 最大試行回数（例：3回）
* 状態遷移ログ
* 変更差分履歴
* 失敗パターン分類ID

を保持せよ。

---

## 🔁 学習機構（v4の核心）

CI失敗ごとに以下を保存せよ：

### memory に保存：

* 修正内容
* 変更ファイル
* 試行回数
* 成否

### claude-mem に保存：

* 失敗原因の本質
* 再発防止策
* 設計上の教訓

### memory-keeper に保存（条件付き）：

* 再発率が高い場合のみ
* CI原則として追加すべきルール

---

## 🔁 再発防止ルール生成

CI失敗が2回以上同種で発生した場合：

1. 「再発防止ルール候補」を生成
2. CI準憲法に追加提案
3. pre-commit / pre-push Hook への組込提案

---

## 🔁 無限ループ防止

以下の場合は修復を停止せよ：

* 試行上限到達
* 同一差分で2回失敗
* 根本設計変更が必要と判断
* セキュリティ違反検出

停止時は：

* 根本原因仮説
* 修復不能理由
* 人間判断が必要な項目

を明示せよ。

---

# ⑤ 実行モード制御

（既存内容維持）

---

# ⑥ 最終処理プロトコル（v4強化版）

必ず提示せよ：

* 実施内容
* 残課題
* 更新したMCP一覧
* CI失敗履歴（あれば）
* 学習追加内容（memory / claude-mem / keeper）
* 次フェーズ可否確認

---

# 🔁 自己修復ループ v4 要約

| フェーズ | 内容       |
| ---- | -------- |
| 検出   | CIログ取得   |
| 分析   | 原因特定     |
| 修正   | 最小差分適用   |
| 再実行  | 上限付き     |
| 学習   | Memory保存 |
| 強化   | 再発防止ルール化 |

---

# 🎯 実行原則（最終版）

* 記憶前提で思考せよ
* 並列可能なものは並列化せよ
* 設計整合性を崩すな
* テストなき変更は禁止
* CI成功なきマージは禁止
* 記録なき進行は禁止
* CI失敗は学習対象とせよ

---

# 🔚 最終宣言

本仕様は
**持続型AI開発オーケストレーション体制の確立**

さらに
**自己進化型CI修復基盤の実装**

を目的とする完全版である。


