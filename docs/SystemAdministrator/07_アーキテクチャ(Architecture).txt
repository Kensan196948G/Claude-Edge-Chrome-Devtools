================================================================================
  Claude-EdgeChromeDevTools アーキテクチャ
  Architecture
================================================================================

【システムアーキテクチャ概要】

┌─────────────────────────────────────────────────────────────────────────┐
│                         Windows マシン                                   │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  start.bat（エントリーポイント）                                    │  │
│  │    │                                                               │  │
│  │    ├─ [1] Claude-EdgeDevTools.ps1                                 │  │
│  │    ├─ [2] Claude-ChromeDevTools.ps1                               │  │
│  │    ├─ [3] test-edge.ps1                                           │  │
│  │    └─ [4] test-chrome.ps1                                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                           ↓                                              │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  config.json（設定読み込み）                                       │  │
│  │    - zDrive, linuxHost, linuxBase, ports                          │  │
│  │    - edgeExe, chromeExe, statusline                               │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                           ↓                                              │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  ポート自動選択ロジック                                             │  │
│  │    Get-NetTCPConnection でポート確認 → 利用可能なポート選択        │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                           ↓                                              │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Edge/Chrome 起動（リモートデバッグモード）                         │  │
│  │    - 専用プロファイル: C:\DevTools-{browser}-{port}                │  │
│  │    - リモートデバッグポート: --remote-debugging-port={port}         │  │
│  │    - DevTools Preferences事前設定（Edge版）                        │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                           ↓                                              │
│         DevTools Protocol (HTTP/WebSocket)                               │
│              localhost:{port}                                            │
│                           ↓                                              │
└──────────────────────────┼──────────────────────────────────────────────┘
                           │
                           │ SSH リモートポートフォワーディング
                           │ ssh -R {port}:127.0.0.1:{port}
                           ↓
┌─────────────────────────────────────────────────────────────────────────┐
│                        Linux ホスト (windows-dev)                        │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  run-claude.sh（動的生成）                                         │  │
│  │    - DevTools接続確認（curl http://127.0.0.1:{port}/json/version） │  │
│  │    - 環境変数設定（CLAUDE_CHROME_DEBUG_PORT, MCP_CHROME_DEBUG_PORT)│  │
│  │    - 初期プロンプト自動入力                                         │  │
│  │    - claude --dangerously-skip-permissions 起動                    │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                           ↓                                              │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Claude Code                                                       │  │
│  │    - MCP Chrome DevTools統合                                       │  │
│  │    - Statusline表示（statusline.sh）                               │  │
│  │    - プロジェクト開発環境                                           │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘

【コンポーネント詳細】

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■1. start.bat（対話型ランチャー）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【役割】
  - ユーザーインターフェースの提供
  - スクリプト選択メニューの表示
  - PowerShellスクリプトの実行制御

【処理フロー】
  1. Windows Terminal確認（管理者権限時）
  2. メニュー表示
  3. ユーザー入力受付
  4. 選択されたPowerShellスクリプトを実行
     pwsh -NoProfile -ExecutionPolicy Bypass -File "%~dp0%script_name%"
  5. 結果表示とメニュー復帰

【技術仕様】
  - 言語: Windows Batch Script
  - 実行モード: 対話型
  - Windows Terminal自動起動対応

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■2. Claude-EdgeDevTools.ps1 / Claude-ChromeDevTools-Final.ps1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【役割】
  - メインオーケストレーター
  - 環境セットアップと統合制御

【処理フロー】
  ① 設定ファイル読み込み（config.json）
  ② ポート自動選択（Get-AvailablePort関数）
  ③ ブラウザ選択UI表示
  ④ プロジェクト選択UI表示
  ⑤ ブラウザDevTools起動
     - 既存プロセスのクリーンアップ
     - プロファイルディレクトリ作成
     - DevTools Preferences設定（Edge版）
     - ブラウザ起動
     - 接続テスト（最大15秒待機）
  ⑥ run-claude.sh動的生成
     - ヒアストリング使用（bash変数保護）
     - CRLF → LF変換
     - UTF-8 (BOM無し)で保存
  ⑦ Statusline設定（有効時）
     - jq確認・インストール
     - statusline.shコピー
     - settings.json生成
     - グローバル設定更新
  ⑧ Claude Code グローバル設定適用 (base64 SSH転送)
     - config.json の claudeCode セクションを読み取り
     - Linux側 ~/.claude/settings.json へ jqマージパターンで適用
     - 既存のpermissions, plugins, hooksは保持
  ⑨ .mcp.jsonバックアップ
  ⑩ chmod +x実行（SSH経由）
  ⑪ Linuxポートクリーンアップ（fuser -k）
  ⑫ SSH接続 + run-claude.sh実行
     ssh -t -o ControlMaster=no -o ControlPath=none \
         -R "${PORT}:127.0.0.1:${PORT}" $LinuxHost \
         "cd $LinuxBase/$ProjectName && ./run-claude.sh"

【技術仕様】
  - 言語: PowerShell 5.1+
  - エラー処理: $ErrorActionPreference = "Stop"
  - ネットワーク: Get-NetTCPConnection, Invoke-WebRequest
  - SSH: OpenSSH Client

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■3. config.json
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【役割】
  - 中央集約設定管理
  - 環境固有のパスやポート設定

【データ構造】
  {
    "zDrive": "Z:\\",                      // Windowsプロジェクトルート
    "linuxHost": "windows-dev",            // SSHホスト名
    "linuxBase": "/mnt/LinuxHDD",          // Linuxプロジェクトベース
    "ports": [9222, 9223, 9224, 9225],     // DevToolsポート配列
    "edgeExe": "...",                      // Edge実行ファイルパス
    "chromeExe": "...",                    // Chrome実行ファイルパス
    "statusline": { "enabled": true }      // Statusline機能
  }

【技術仕様】
  - フォーマット: JSON
  - エンコーディング: UTF-8 (BOM無し)
  - 読み込み: Get-Content | ConvertFrom-Json

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■4. run-claude.sh（動的生成）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【役割】
  - Linux上でのClaude Code起動制御
  - DevTools接続確認と環境変数設定

【処理フロー】
  1. DevTools応答確認（最大10回リトライ）
     curl -sf --connect-timeout 2 http://127.0.0.1:${PORT}/json/version
  2. 環境変数設定
     export CLAUDE_CHROME_DEBUG_PORT=${PORT}
     export MCP_CHROME_DEBUG_PORT=${PORT}
     export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1
  3. 初期プロンプト自動入力 + Claude起動
     - INIT_PROMPTはheredoc方式で定義（バッククォート・引用符の破損回避）
       INIT_PROMPT=$(cat << 'INITPROMPTEOF' ... INITPROMPTEOF)
     echo "$INIT_PROMPT" | claude --dangerously-skip-permissions
  4. 自動再起動ループ（異常終了時）

【技術仕様】
  - 言語: Bash
  - エラー処理: set -euo pipefail
  - シグナルトラップ: trap 'echo "🛑 Ctrl+C で終了"; exit 0' INT
  - エンコーディング: UTF-8 (BOM無し), LF改行

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■5. statusline.sh
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【役割】
  - Claude Code Statusline表示のカスタマイズ
  - プロジェクト情報の可視化

【表示内容】
  - 📁 カレントディレクトリ
  - 🌿 Gitブランチ
  - 🤖 モデル名
  - 📟 Claudeバージョン
  - 🎨 出力スタイル
  - 🧠 コンテキスト使用率（プログレスバー付き）

【技術仕様】
  - 言語: Bash
  - 依存: jq（JSON処理）
  - 実行権限: chmod +x

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■6. test-edge.ps1 / test-chrome.ps1
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【役割】
  - DevTools接続テスト
  - デバッグ情報の取得

【処理フロー】
  1. ポート範囲（9222-9225）をループ
  2. /json/version エンドポイントに接続試行
  3. 成功時:
     - バージョン情報表示
     - WebSocketデバッガーURL表示
     - スクリーンショット撮影（オプション）
  4. 失敗時: 次のポートへ

【技術仕様】
  - 言語: PowerShell
  - HTTP: Invoke-RestMethod
  - タイムアウト: 3秒

【データフロー図】

Windows                           SSH Tunnel                      Linux
─────────────────────────────────────────────────────────────────────────

 Edge/Chrome                                                  Claude Code
    ↓                                                                ↑
 DevTools                                                            │
 Protocol                                                            │
 (HTTP/WS)                                                           │
    ↓                                                                │
 localhost:9222 ───┐                                                │
                   │                                                │
                   │  SSH -R 9222:127.0.0.1:9222                    │
                   └─────────────────────────────────────→ 127.0.0.1:9222
                                                                    │
                   ┌────────────────────────────────────────────────┘
                   │
                   └─→ MCP Chrome DevTools
                        (ブラウザ制御・デバッグ)

【セキュリティアーキテクチャ】

■通信経路
  - ローカル通信のみ（localhost）
  - SSHトンネル暗号化
  - ファイアウォール内での動作

■認証・認可
  - SSHキーベース認証
  - ブラウザプロファイル隔離
  - --dangerously-skip-permissions フラグ（開発環境専用）

■リスク軽減策
  - ポート範囲の限定
  - 専用プロファイルディレクトリ
  - プロセスクリーンアップ

【スケーラビリティ】

■並列実行
  - 複数プロジェクト同時起動可能
  - ポート自動割り当てによる衝突回避

■拡張性
  - 新ブラウザ追加容易（config.json + 新スクリプト）
  - カスタム初期プロンプト設定可能
  - Statusline カスタマイズ可能

【パフォーマンス特性】

■起動時間
  - ブラウザ起動: 2-5秒
  - SSH接続: 1-2秒
  - Claude Code起動: 3-5秒
  - 合計: 約10-15秒

■リソース使用量
  - メモリ: ブラウザ（200-500MB）+ Claude Code（100-300MB）
  - CPU: 起動時スパイク、アイドル時低負荷
  - ネットワーク: SSH接続のみ（低帯域）

【障害時の動作】

■フェイルセーフ機構
  - DevTools接続失敗時: ユーザー確認プロンプト
  - SSH接続失敗時: エラーメッセージとスクリプト終了
  - Claude異常終了時: 自動再起動（3秒遅延）

■リカバリー手順
  - ポート衝突: 自動的に次の利用可能ポート選択
  - プロセス残存: 自動クリーンアップ（fuser -k）
  - ブラウザクラッシュ: 手動再起動が必要
