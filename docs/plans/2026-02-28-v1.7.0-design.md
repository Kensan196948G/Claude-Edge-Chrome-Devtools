# v1.7.0 設計書: CI修復・テストカバレッジ100%・レガシー整理

**日付**: 2026-02-28
**アプローチ**: 単一ブランチ (`feature/v1.7.0`)・構造化コミット

---

## 概要

v1.7.0 では以下の3トラックを実施する:

1. **CI/CD 修復**: Validate Scripts / DevTools Integration の2つの失敗を修正
2. **テストカバレッジ 100%**: BrowserManager.psm1 / UI.psm1 のPesterテスト追加
3. **レガシースクリプト整理**: Edge/Chrome個別スクリプトをdeprecatedフォルダに移動

---

## Track 1: CI/CD 修復

### 1-1. Validate Scripts CI 修復

**ファイル**: `.github/workflows/validate-scripts.yml` (122-132行目)

**根本原因**: CI が `[regex]::Escape('-Layout')` で `Claude-DevTools.ps1` 内の「`-Layout`」をリテラル検索するが、ファイル内には `$Layout`（param宣言）と `.PARAMETER Layout`（ヘルプテキスト）のみ存在。

**修正**: param() ブロック内の `$ParamName` 宣言を検出する方式に変更。

```powershell
# Before
$cliParams = @('-Browser', '-Project', '-Port', '-NonInteractive', '-DryRun', '-Layout')
if ($mainScript -match [regex]::Escape($param))

# After
$cliParams = @('Browser', 'Project', 'Port', 'NonInteractive', 'DryRun', 'Layout')
if ($mainScript -match "\`$$($param)\b")
```

### 1-2. DevTools Integration CI 修復

**ファイル**: `.github/workflows/devtools-integration.yml` (125行目付近)

**根本原因**: `cp` でフックファイルをコピーすると実行権限 (`+x`) が付与されない。git は非実行ファイルのフックをサイレントにスキップするため、機密情報が検出されずコミットが成功してしまう。

**修正**: `cp` 後に `chmod +x` を追加。

```yaml
cp ../scripts/hooks/pre-commit.sh .claude/hooks/
chmod +x .claude/hooks/pre-commit.sh
chmod +x .git/hooks/pre-commit
```

---

## Track 2: テストカバレッジ 100%

### 2-1. tests/BrowserManager.Tests.ps1

対象: `scripts/lib/BrowserManager.psm1` (365行、5関数)

| 関数 | テストケース |
|------|------------|
| `Start-DevToolsBrowser` | ブラウザ不在時エラー、プロファイルディレクトリ作成、Start-Process モック |
| `Stop-DevToolsBrowser` | 既に終了済み、グレースフルシャットダウン、タイムアウト時強制終了 |
| `Wait-DevToolsReady` | 即座応答、タイムアウト、Invoke-RestMethod モック |
| `Set-BrowserDevToolsPreferences` | 新規Preferences作成、既存マージ、JSON形式検証 |
| `Remove-ExistingBrowserProfiles` | ポートリッスン中プロセス検出・終了 |

### 2-2. tests/UI.Tests.ps1

対象: `scripts/lib/UI.psm1` (226行、3関数)

| 関数 | テストケース |
|------|------------|
| `Select-Browser` | デフォルト値 (edge/chrome)、戻り値構造 (Name, Exe, Type) |
| `Select-Project` | ディレクトリ一覧取得、最近使用ソート、空ディレクトリ時エラー |
| `Resolve-ProjectRootPath` | ドライブパス成功、UNCフォールバック、両方失敗時throw |

---

## Track 3: レガシースクリプト整理

### ディレクトリ構造変更

```
scripts/
├── main/
│   ├── Claude-DevTools.ps1              # 統合スクリプト（変更なし）
│   ├── Claude-EdgeDevTools.ps1          # → ラッパースクリプトに置換
│   └── Claude-ChromeDevTools-Final.ps1  # → ラッパースクリプトに置換
├── deprecated/                           # ★ 新規作成
│   ├── README.md                        # 非推奨説明
│   ├── Claude-EdgeDevTools.ps1          # 元のEdge版
│   └── Claude-ChromeDevTools-Final.ps1  # 元のChrome版
```

### ラッパースクリプト

置換後の `scripts/main/Claude-EdgeDevTools.ps1`:
```powershell
Write-Warning "このスクリプトは非推奨です。Claude-DevTools.ps1 を使用してください。"
& "$PSScriptRoot\Claude-DevTools.ps1" -Browser edge @PSBoundParameters
```

置換後の `scripts/main/Claude-ChromeDevTools-Final.ps1`:
```powershell
Write-Warning "このスクリプトは非推奨です。Claude-DevTools.ps1 を使用してください。"
& "$PSScriptRoot\Claude-DevTools.ps1" -Browser chrome @PSBoundParameters
```

---

## コミット構造

1. `fix(ci): validate-scripts パラメータ検証修正`
2. `fix(ci): devtools-integration pre-commit.sh 実行権限修正`
3. `test: BrowserManager.psm1 ユニットテスト追加`
4. `test: UI.psm1 ユニットテスト追加`
5. `refactor: レガシースクリプトをdeprecatedフォルダに移動`
6. `docs: CLAUDE.md ファイル構造更新`

---

## 影響範囲

- **影響範囲**: 小（CI設定ファイル + テスト追加 + スクリプト移動のみ）
- **リスク**: 低（既存機能への変更なし、後方互換ラッパーあり）
- **rollback**: git revert で即座に戻せる
