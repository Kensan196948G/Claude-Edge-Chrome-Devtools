name: DevTools Integration Test

on:
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'  # UTC 17:00 = JST 02:00
  workflow_dispatch:
    inputs:
      browser:
        description: 'ãƒ–ãƒ©ã‚¦ã‚¶é¸æŠ'
        required: true
        default: 'chrome'
        type: choice
        options:
          - edge
          - chrome
      port:
        description: 'DevToolsãƒãƒ¼ãƒˆ'
        required: false
        default: '9222'

jobs:
  test-devtools-protocol:
    name: DevTools Protocol Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Start Chrome with Remote Debugging
        run: |
          # Chrome ã‚’ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
          google-chrome \
            --headless \
            --remote-debugging-port=9222 \
            --user-data-dir=/tmp/chrome-devtools-test \
            --no-first-run \
            --no-default-browser-check \
            &

          # èµ·å‹•å¾…æ©Ÿ
          sleep 3

      - name: Test DevTools Endpoints
        run: |
          echo "ğŸ” DevTools Protocol ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ"

          PORT=9222

          # /json/version
          echo ""
          echo "ğŸ“‹ 1. /json/version"
          if curl -sf "http://localhost:${PORT}/json/version" | jq '.'; then
            echo "âœ… OK"
          else
            echo "âŒ FAIL"
            exit 1
          fi

          # /json/list
          echo ""
          echo "ğŸ“‹ 2. /json/list (ã‚¿ãƒ–ä¸€è¦§)"
          TAB_COUNT=$(curl -sf "http://localhost:${PORT}/json/list" | jq 'length')
          echo "ã‚¿ãƒ–æ•°: ${TAB_COUNT}"

          if [ "$TAB_COUNT" -gt 0 ]; then
            echo "âœ… OK"
          else
            echo "âŒ FAIL: ã‚¿ãƒ–ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # WebSocket ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
          echo ""
          echo "ğŸ“‹ 3. WebSocket ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ"
          WS_URL=$(curl -sf "http://localhost:${PORT}/json/list" | jq -r '.[0].webSocketDebuggerUrl')
          echo "WebSocket URL: ${WS_URL}"

          if [ -n "$WS_URL" ]; then
            echo "âœ… OK"
          else
            echo "âŒ FAIL"
            exit 1
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ã™ã¹ã¦ã®DevTools Protocol ãƒ†ã‚¹ãƒˆæˆåŠŸ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  test-hooks:
    name: Hooks Functionality Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Test on-startup.sh
        run: |
          echo "ğŸ” on-startup.sh ãƒ†ã‚¹ãƒˆ"

          # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          export CLAUDE_CHROME_DEBUG_PORT=9222
          export MCP_CHROME_DEBUG_PORT=9222
          export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1

          # .mcp.json ãƒ¢ãƒƒã‚¯ä½œæˆ
          mkdir -p test-project/.claude/hooks
          cp scripts/hooks/on-startup.sh test-project/.claude/hooks/
          echo '{"mcpServers":{"test-mcp":{}}}' > test-project/.mcp.json

          cd test-project
          bash .claude/hooks/on-startup.sh

      - name: Test pre-commit.sh
        run: |
          echo "ğŸ” pre-commit.sh ãƒ†ã‚¹ãƒˆ"

          cd test-project
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"

          mkdir -p .claude/hooks
          cp ../scripts/hooks/pre-commit.sh .claude/hooks/
          ln -s ../../.claude/hooks/pre-commit.sh .git/hooks/pre-commit

          # Token ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          echo "ghp_1234567890123456789012345678901234567" > secret.txt
          git add secret.txt

          # ã‚³ãƒŸãƒƒãƒˆè©¦è¡Œï¼ˆå¤±æ•—ã™ã‚‹ã¹ãï¼‰
          if git commit -m "test" 2>&1 | grep "æ©Ÿå¯†æƒ…å ±ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"; then
            echo "âœ… pre-commit hook ãŒæ­£å¸¸ã«å‹•ä½œ"
          else
            echo "âŒ pre-commit hook ãŒæ©Ÿå¯†æƒ…å ±ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ"
            exit 1
          fi

  test-mcp-setup:
    name: MCP Setup Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Test MCP Setup Script
        run: |
          echo "ğŸ” MCP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ†ã‚¹ãƒˆ"

          mkdir -p test-project
          echo '{"mcpServers":{}}' > test-project/.mcp.json

          # setup-mcp.sh å®Ÿè¡Œï¼ˆGitHub Token ãªã—ï¼‰
          bash scripts/mcp/setup-mcp.sh test-project "" ""

          # MCP ã‚µãƒ¼ãƒãƒ¼ãŒè¿½åŠ ã•ã‚ŒãŸã‹ç¢ºèª
          MCP_COUNT=$(jq '.mcpServers | length' test-project/.mcp.json)
          echo "è¿½åŠ ã•ã‚ŒãŸ MCP ã‚µãƒ¼ãƒãƒ¼æ•°: ${MCP_COUNT}"

          if [ "$MCP_COUNT" -gt 0 ]; then
            echo "âœ… MCP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æˆåŠŸ"
          else
            echo "âŒ MCP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—"
            exit 1
          fi
