name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå· (ä¾‹: v1.2.1)'
        required: true

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${VERSION}"

      - name: Generate Changelog
        id: changelog
        run: |
          echo "ğŸ“ å¤‰æ›´å±¥æ­´ç”Ÿæˆä¸­..."

          # å‰å›ã®ã‚¿ã‚°ã‚’å–å¾—
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "å‰å›ãƒªãƒªãƒ¼ã‚¹: ${PREVIOUS_TAG}"
            COMMIT_RANGE="${PREVIOUS_TAG}..HEAD"
          else
            echo "åˆå›ãƒªãƒªãƒ¼ã‚¹"
            COMMIT_RANGE="HEAD"
          fi

          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚³ãƒŸãƒƒãƒˆåˆ†é¡
          FEATURES=$(git log $COMMIT_RANGE --pretty=format:"%s" --no-merges 2>/dev/null | grep -E '^feat' | sed 's/^/- /' || true)
          FIXES=$(git log $COMMIT_RANGE --pretty=format:"%s" --no-merges 2>/dev/null | grep -E '^fix' | sed 's/^/- /' || true)
          DOCS=$(git log $COMMIT_RANGE --pretty=format:"%s" --no-merges 2>/dev/null | grep -E '^docs' | sed 's/^/- /' || true)
          TESTS=$(git log $COMMIT_RANGE --pretty=format:"%s" --no-merges 2>/dev/null | grep -E '^test' | sed 's/^/- /' || true)
          REFACTORS=$(git log $COMMIT_RANGE --pretty=format:"%s" --no-merges 2>/dev/null | grep -E '^(refactor|chore)' | sed 's/^/- /' || true)
          OTHER=$(git log $COMMIT_RANGE --pretty=format:"%s" --no-merges 2>/dev/null | grep -vE '^(feat|fix|docs|test|refactor|chore)' | sed 's/^/- /' || true)

          # ãƒ•ãƒ«ã‚³ãƒŸãƒƒãƒˆä¸€è¦§ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
          ALL_COMMITS=$(git log $COMMIT_RANGE --pretty=format:"- %s (%h)" --no-merges | head -30 || true)

          # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å‡ºåŠ›
          {
            echo "features<<EOF"
            echo "$FEATURES"
            echo "EOF"
            echo "fixes<<EOF"
            echo "$FIXES"
            echo "EOF"
            echo "docs<<EOF"
            echo "$DOCS"
            echo "EOF"
            echo "tests<<EOF"
            echo "$TESTS"
            echo "EOF"
            echo "refactors<<EOF"
            echo "$REFACTORS"
            echo "EOF"
            echo "other<<EOF"
            echo "$OTHER"
            echo "EOF"
            echo "all_commits<<EOF"
            echo "$ALL_COMMITS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "ğŸš€ Release ${{ steps.version.outputs.version }}"
          body: |
            ## ğŸ‰ Claude-EdgeChromeDevTools ${{ steps.version.outputs.version }}

            **ãƒªãƒªãƒ¼ã‚¹æ—¥**: ${{ github.event.repository.updated_at }}

            ---

            ${{ steps.changelog.outputs.features != '' && '### âœ¨ æ–°æ©Ÿèƒ½ãƒ»æ”¹å–„' || '' }}
            ${{ steps.changelog.outputs.features }}

            ${{ steps.changelog.outputs.fixes != '' && '### ğŸ› ãƒã‚°ä¿®æ­£' || '' }}
            ${{ steps.changelog.outputs.fixes }}

            ${{ steps.changelog.outputs.docs != '' && '### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ' || '' }}
            ${{ steps.changelog.outputs.docs }}

            ${{ steps.changelog.outputs.tests != '' && '### ğŸ§ª ãƒ†ã‚¹ãƒˆ' || '' }}
            ${{ steps.changelog.outputs.tests }}

            ${{ steps.changelog.outputs.refactors != '' && '### ğŸ”§ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ãƒ»ä¿å®ˆ' || '' }}
            ${{ steps.changelog.outputs.refactors }}

            ${{ steps.changelog.outputs.other != '' && '### ğŸ“¦ ãã®ä»–' || '' }}
            ${{ steps.changelog.outputs.other }}

            ---

            ### ğŸ“‹ å…¨å¤‰æ›´ã‚³ãƒŸãƒƒãƒˆ

            ${{ steps.changelog.outputs.all_commits }}

            ---

            ### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

            ```cmd
            git clone https://github.com/Kensan196948G/Claude-Edge-Chrome-Devtools.git
            cd Claude-Edge-Chrome-Devtools
            start.bat
            ```

            ### ğŸ”— ãƒªãƒ³ã‚¯

            - [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/Kensan196948G/Claude-Edge-Chrome-Devtools/tree/main/docs)
            - [MIGRATION.md](https://github.com/Kensan196948G/Claude-Edge-Chrome-Devtools/blob/main/MIGRATION.md)
            - [README.md](https://github.com/Kensan196948G/Claude-Edge-Chrome-Devtools/blob/main/README.md)

            ---

            Co-Authored-By: GitHub Copilot <223556219+Copilot@users.noreply.github.com>
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-artifacts:
    name: Build Release Artifacts
    runs-on: windows-latest
    needs: create-release

    steps:
      - uses: actions/checkout@v4

      - name: Create Distribution Package
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ é…å¸ƒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆä¸­..." -ForegroundColor Cyan

          $version = if ($env:GITHUB_REF -match 'refs/tags/(.*)') { $matches[1] } else { "dev" }
          $packageName = "Claude-EdgeChromeDevTools-$version"

          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          New-Item -ItemType Directory -Path $packageName -Force | Out-Null

          # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
          $include = @(
            "scripts",
            "config",
            "docs",
            ".claude",
            "tests",
            "start.bat",
            "CLAUDE.md",
            "README.md",
            "MIGRATION.md",
            "LICENSE"
          )

          foreach ($item in $include) {
            if (Test-Path $item) {
              Copy-Item -Path $item -Destination "$packageName\" -Recurse -Force
            }
          }

          # æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
          Remove-Item -Path "$packageName\config\backups" -Recurse -Force -ErrorAction SilentlyContinue

          # ZIP åœ§ç¸®
          Compress-Archive -Path $packageName -DestinationPath "${packageName}.zip" -Force

          Write-Host "âœ… ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆå®Œäº†: ${packageName}.zip"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: Claude-EdgeChromeDevTools-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
